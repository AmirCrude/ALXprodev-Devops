#!/bin/bash

# Create CSV report with averages from Pokémon JSON files

DATA_DIR="pokemon_data"
CSV_FILE="pokemon_report.csv"

# Check if data directory exists
if [ ! -d "$DATA_DIR" ]; then
    echo "Error: Directory '$DATA_DIR' not found!"
    echo "Please run Task 2 first to fetch the Pokémon data."
    exit 1
fi

# Count JSON files
FILE_COUNT=$(ls "$DATA_DIR"/*.json 2>/dev/null | wc -l)
if [ "$FILE_COUNT" -eq 0 ]; then
    echo "Error: No JSON files found in '$DATA_DIR'"
    exit 1
fi

echo "Generating Pokémon data report..."

# Create CSV header
echo "Name,Height (m),Weight (kg)" > "$CSV_FILE"

# Process each JSON file
for json_file in "$DATA_DIR"/*.json; do
    if [ -f "$json_file" ]; then
        # Extract data using jq
        name=$(./bin/jq.exe -r '.name' "$json_file")
        height_dm=$(./bin/jq.exe -r '.height' "$json_file")
        weight_hg=$(./bin/jq.exe -r '.weight' "$json_file")
        
        # Convert units: dm to m, hg to kg (divide by 10)
        height_m=$(echo "$height_dm" | awk '{printf "%.1f", $1/10}')
        weight_kg=$(echo "$weight_hg" | awk '{val=$1/10; printf (val==int(val)) ? "%d" : "%.1f", val}')
        
        # Capitalize first letter of name
        name_cap=$(echo "$name" | awk '{print toupper(substr($0,1,1)) substr($0,2)}')
        
        # Append to CSV
        echo "$name_cap,$height_m,$weight_kg" >> "$CSV_FILE"
    fi
done

# Sort the CSV alphabetically by name (excluding header)
if [ -f "$CSV_FILE" ] && [ $(wc -l < "$CSV_FILE") -gt 1 ]; then
    # Create temporary sorted file
    TEMP_FILE=$(mktemp)
    head -n 1 "$CSV_FILE" > "$TEMP_FILE"
    tail -n +2 "$CSV_FILE" | sort >> "$TEMP_FILE"
    mv "$TEMP_FILE" "$CSV_FILE"
    
    echo "CSV Report generated at: $CSV_FILE"
    echo ""
    
    # Display CSV content
    cat "$CSV_FILE"
    echo ""
    
    # Calculate and display averages using awk
    AVG_HEIGHT=$(awk -F ',' 'NR>1 {sum+=$2; count++} END {if(count>0) printf "%.2f", sum/count}' "$CSV_FILE")
    AVG_WEIGHT=$(awk -F ',' 'NR>1 {sum+=$3; count++} END {if(count>0) printf "%.2f", sum/count}' "$CSV_FILE")
    
    echo "Average Height: $AVG_HEIGHT m"
    echo "Average Weight: $AVG_WEIGHT kg"
else
    echo "Error: Failed to generate CSV report"
    rm -f "$CSV_FILE"
    exit 1
fi

exit 0